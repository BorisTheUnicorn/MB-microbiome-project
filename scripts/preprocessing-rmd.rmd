---
title: "NM Microbiome - 01 Data Preprocessing"
author: "Orr Tobaly & Nikol Elyashov"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: united
    highlight: tango
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 6
)
```

## 1. Setup and Library Loading

```{r load-libraries}
# Load required packages
library(vegan)
library(microbiome)
library(phyloseq)
library(qiime2R)
library(microeco)
library(tidyverse)
library(GUniFrac)
library(patchwork)
library(readxl)
library(sva)
library(magrittr)
library(dplyr)
library(ggplot2)

# Source custom functions
source("../R/preprocessing_functions.r")
source("../R/visualization_functions.r")

# Set data paths
raw_data_dir <- "../data/raw/"
processed_to_ANCOM_data_dir <- "../data/processed_to_ANCOM/"
processed_CLR_data_dir <- "../data/processed_CLR/"

# Create processed directory if it doesn't exist
if(!dir.exists(processed_to_ANCOM_data_dir)) {
  dir.create(processed_to_ANCOM_data_dir, recursive = TRUE)
}
if(!dir.exists(processed_CLR_data_dir)) {
  dir.create(processed_CLR_data_dir, recursive = TRUE)
}
```

## 2. Data Import

```{r import-data}
# Import QIIME2 data using our custom function
dataset <- import_qiime2_data(
  metadata_path = file.path(raw_data_dir, "00.metadata.combined.2020_2021.tsv"),
  feature_table_path = file.path(raw_data_dir, "table-dada2.qza"),
  taxonomy_path = file.path(raw_data_dir, "taxonomy-dada2.qza"),
  tree_path = file.path(raw_data_dir, "rooted-tree-dada2.qza")
)

# Apply the function to create enhanced time variables
dataset <- create_enhanced_time_variables(dataset)

# Verify the new variables
time_summary <- dataset$sample_table %>%
  group_by(cohort, time, collection_date, season) %>%
  summarise(count = n(), .groups = 'drop') %>%
  arrange(collection_date)

print("Summary of time variables (full dataset):")
print(time_summary)

# Visualize sample distribution across time (full dataset)
time_dist_plot <- ggplot(dataset$sample_table, 
                         aes(x = collection_date, fill = season)) +
  geom_bar() +
  labs(title = "Sample Distribution by Collection Date (Full Dataset)",
       x = "Collection Date", 
       y = "Number of Samples") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

print(time_dist_plot)

# Basic dataset summary (full dataset)
print("Summary of the full dataset:")
print(dataset)
```

## 3. Data Inspection

```{r data-inspection}
# Sample count per time point
table(dataset$sample_table$time)

# Sample count per case/control status
table(dataset$sample_table$case_control)

# Sample count per year
table(dataset$sample_table$year)

# Sample count per batch
table(dataset$sample_table$batch)

# Calculate basic taxonomic composition
tax_summary <- dataset$tax_table %>%
  as.data.frame() %>%
  group_by(Phylum) %>%
  summarise(count = n()) %>%
  arrange(desc(count))

# Display top 10 phyla
head(tax_summary, 10)
```

## 4. Longitudinal Carriage Status Classification

```{r carriage-classification}
# Classify subjects based on NM carriage dynamics
# This function calculates 'carriage_group' and 'susceptibility_group' per participant.
participant_carriage_summary <- classify_longitudinal_carriage(dataset)

# Display the distribution of the new carriage group categories
print("Distribution of Carriage Groups (per participant):")
print(table(participant_carriage_summary$carriage_group))

# Display the distribution of the new susceptibility group
print("Distribution of Susceptibility Groups (per participant; 0 = Never Case, 1 = Ever Case):")
print(table(participant_carriage_summary$susceptibility_group))

# Update the dataset's sample_table with these new classifications
dataset <- add_carriage_columns_to_dataset(
  dataset = dataset,
  carriage_classification_df = participant_carriage_summary
)

# Verify the new columns in the dataset's sample_table
print("Cross-tabulation of Carriage Group by Time Point (in dataset$sample_table):")
print(table(dataset$sample_table$carriage_group, dataset$sample_table$time, useNA = "ifany"))

print("Cross-tabulation of Susceptibility Group by Time Point (in dataset$sample_table):")
print(table(dataset$sample_table$susceptibility_group, dataset$sample_table$time, useNA = "ifany"))

# Final quick check on rownames for peace of mind
# This check should pass if add_carriage_columns_to_dataset worked as intended.
if (nrow(dataset$sample_table) > 0 && 
    !all(rownames(dataset$sample_table) == as.character(dataset$sample_table[[1]]))) {
  warning("Final check: Rownames of dataset$sample_table might not align with SampleIDs in the first column.")
} else if (nrow(dataset$sample_table) > 0) {
  # message("Final rowname check passed.")
}

```

## 5. Calculate Beta Diversity and Visualize Initial Distribution

```{r beta-diversity}
# Calculate beta diversity
dataset$cal_betadiv(unifrac = TRUE)

# Create dataset without batch 4
dataset_no_b4 <- remove_batch4(dataset)

# Create ordination plots for potential batch effects and biological factors

# Year
plot_pcoa(
  dataset = dataset, 
  plot_color_var = "year", 
  plot_shape_var = "batch", 
  title = "Samples by Year"
)

# Batch
plot_pcoa(
  dataset = dataset,
  plot_color_var = "batch",
  plot_shape_var = "cohort", 
  title = "Samples by Sequencing Batch"
)

# Time (0, 2, 4)
plot_pcoa(
  dataset = dataset_no_b4,
  plot_color_var = "time",
  plot_shape_var = "cohort",
  facet_var = "batch",
  title = "Samples by Time Point"
)

# Carriage
plot_pcoa(
  dataset = dataset_no_b4,
  plot_color_var = "case_control",
  plot_shape_var = "cohort",
  facet_var = "batch",
  title = "Samples by NM Carriage Status"
)

# Collection Date
plot_pcoa(
  dataset = dataset_no_b4,
  plot_color_var = "collection_date",
  plot_shape_var = "time",
  facet_var = "batch",
  title = "Samples by Collection Date"
)

# Season
plot_pcoa(
  dataset = dataset_no_b4,
  plot_color_var = "season",
  plot_shape_var = "cohort",
  facet_var = "batch",
  title = "Samples by Season"
)

# Cohort
plot_pcoa(
  dataset = dataset_no_b4,
  plot_color_var = "cohort",
  plot_shape_var = "time",
  facet_var = "batch",
  title = "Samples by Cohort"
)

# Ever vs. Never Carriers
plot_pcoa(
  dataset = dataset_no_b4,
  plot_color_var = "susceptibility_group",
  plot_shape_var = "cohort",
  facet_var = "batch",
  title = "Samples by Susceptibility Group"
)

# Carriage groups
plot_pcoa(
  dataset = dataset_no_b4,
  plot_color_var = "carriage_group",
  plot_shape_var = "cohort",
  facet_var = "batch",
  title = "Samples by Carriage Group"
)

```

## 6. Export Preprocessed ANCOM data

```{r export-data-ancom}
# Save the dataset as RDS for later use
saveRDS(dataset, file = file.path(processed_to_ANCOM_data_dir, "preprocessed_to_ANCOM_microbiome_dataset.rds"))

# Convert to phyloseq for compatibility with other packages
ps_object <- convert_to_phyloseq(dataset)
saveRDS(ps_object, file = file.path(processed_to_ANCOM_data_dir, "preprocessed_to_ANCOM_phyloseq.rds"))

# Export carriage classifications for reference
write.csv(
  carriage_patterns,
  file = file.path(processed_to_ANCOM_data_dir, "carriage_to_ANCOM_classifications.csv"),
  row.names = FALSE
)

# Create and save a summary of the preprocessing
preprocessing_summary <- list(
  sample_counts = list(
    total_samples = nrow(dataset$sample_table),
    samples_by_time = table(dataset$sample_table$time),
    samples_by_carriage = table(dataset$sample_table$case_control),
    samples_by_carriage_group = table(dataset$sample_table$carriage_group),
    samples_by_susceptibility = table(dataset$sample_table$susceptibility_group)
  ),
  feature_counts = list(
    total_features = nrow(dataset$otu_table),
    features_by_phylum = tax_summary
  ),
  preprocessing_steps = c(
    "Imported QIIME2 data",
    "Filtered non-bacterial features and contaminants",
    "create enhanced time variables",
    "Classified longitudinal carriage patterns",
    "Created expanded susceptibility grouping"
  )
)

saveRDS(preprocessing_summary, file = file.path(processed_to_ANCOM_data_dir, "preprocessing_to_ANCOM_summary.rds"))
```

## 7. Create Basic Visualizations of Processed Data to ANCOM

```{r final-visualization-ancom}
# Make sure alpha and beta diversity are calculated first
if(is.null(dataset$alpha_diversity)) {
  dataset$cal_alphadiv(measures = c("Shannon", "Simpson", "Observed"))
}
if(is.null(dataset$beta_diversity)) {
  dataset$cal_betadiv(method = c("bray", "jaccard"))
}

# Taxonomic composition by carriage group
taxa_comp_plot <- plot_taxa_composition(
  dataset = dataset,
  tax_level = "Genus",
  facet_vars = c("batch"), # Pass as a character vector
  n_taxa = 20,
  title = "Taxonomic Composition by Carriage Group and Batch"
)

# Alpha diversity by carriage group
alpha_div_plot <- plot_alpha_diversity(
  dataset = dataset,
  group_var = "carriage_group",
  title = "Alpha Diversity by Carriage Group"
)

# Longitudinal PCoA for carriage groups
longitudinal_pcoa <- plot_longitudinal_pcoa(
  dataset = dataset,
  subject_var = "pid",
  time_var = "time",
  group_var = "carriage_group",
  title = "Longitudinal Microbiome Trajectories by Carriage Group"
)

# Display the plots
print(taxa_comp_plot)
print(alpha_div_plot)
print(longitudinal_pcoa)

# Save the plots
ggsave(file.path(processed_to_ANCOM_data_dir, "taxa_composition_to_ANCOM.png"), taxa_comp_plot, width = 12, height = 8)
ggsave(file.path(processed_to_ANCOM_data_dir, "alpha_diversity_to_ANCOM.png"), alpha_div_plot, width = 12, height = 8)
ggsave(file.path(processed_to_ANCOM_data_dir, "longitudinal_pcoa_to_ANCOM.png"), longitudinal_pcoa, width = 12, height = 8)
```

## 8. Performe CLR transformation on data

```{r CLR}
# — CLR Transformation for Compositional Microbiome Data —
#Clone the dataset 
dataset_clr <- dataset$clone()

#Extract the OTU table
abund <- dataset_clr$otu_table

#Add a small pseudocount to zeros to avoid log(0)
pseudocount <- 0.5
abund[abund == 0] <- pseudocount

#Compute the geometric mean of each sample (column)
geom_mean <- apply(abund, 2, function(x) exp(mean(log(x))))  

#Take log of abundances
log_abund <- log(abund)

#Subtract the log-geometric mean from each log-abundance
clr_mat <- sweep(log_abund, 2, log(geom_mean), "-")

#Update the dataset’s OTU table with CLR-transformed data
dataset_clr$otu_table <- clr_mat

#Inspect the first few CLR values
head(dataset_clr$otu_table)

```


## 9. Export Preprocessed data after CLR

```{r export-data-CLR}
# Save the dataset as RDS for later use
saveRDS(dataset_clr, file = file.path(processed_CLR_data_dir, "preprocessed_CLR_microbiome_dataset.rds"))

# Convert to phyloseq for compatibility with other packages
ps_object <- convert_to_phyloseq(dataset_clr)
saveRDS(ps_object, file = file.path(processed_CLR_data_dir, "preprocessed_CLR_phyloseq.rds"))

# Export carriage classifications for reference
write.csv(
  carriage_patterns,
  file = file.path(processed_CLR_data_dir, "carriage_CLR_classifications.csv"),
  row.names = FALSE
)

# Create and save a summary of the preprocessing
preprocessing_summary <- list(
  sample_counts = list(
    total_samples = nrow(dataset_clr$sample_table),
    samples_by_time = table(dataset_clr$sample_table$time),
    samples_by_carriage = table(dataset_clr$sample_table$case_control),
    samples_by_carriage_group = table(dataset_clr$sample_table$carriage_group),
    samples_by_susceptibility = table(dataset_clr$sample_table$susceptibility_group)
  ),
  feature_counts = list(
    total_features = nrow(dataset_clr$otu_table),
    features_by_phylum = tax_summary
  ),
  preprocessing_steps = c(
    "Imported QIIME2 data",
    "Filtered non-bacterial features and contaminants",
    "create enhanced time variables",
    "Classified longitudinal carriage patterns",
    "Created expanded susceptibility grouping",
    "Performe CLR transformation on data"
  )
)

saveRDS(preprocessing_summary, file = file.path(processed_CLR_data_dir, "preprocessing_CLR_summary.rds"))
```

## 10. Create Basic Visualizations of Processed Data to After CLR

```{r final-visualization-CLR}
# Make sure alpha and beta diversity are calculated first
if(is.null(dataset_clr$alpha_diversity)) {
  dataset_clr$cal_alphadiv(measures = c("Shannon", "Simpson", "Observed"))
}
if(is.null(dataset_clr$beta_diversity)) {
  dataset_clr$cal_betadiv(method = c("Euclidean"))
}

# Longitudinal PCoA for carriage groups
longitudinal_pcoa_CLR <- plot_longitudinal_pcoa(
  dataset = dataset_clr,
  subject_var = "pid",
  time_var = "time",
  group_var = "carriage_group",
  title = "Longitudinal Microbiome Trajectories by Carriage Group after CLR"
)

# Display the plot
print(longitudinal_pcoa_CLR)

# Save the plot
ggsave(file.path(processed_CLR_data_dir, "longitudinal_pcoa_CLR.png"), longitudinal_pcoa_CLR, width = 12, height = 8)
```


## 11. Session Info

```{r session-info}
sessionInfo()
```