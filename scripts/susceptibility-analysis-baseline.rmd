---
title: "NM Microbiome - 02 Original Susceptibility Analysis"
author: "Orr Tobaly & Nikol Elyashov"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: united
    highlight: tango
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 6
)
```

## 1. Setup and Library Loading

```{r load-libraries}
# Load required packages
library(phyloseq)
library(ANCOMBC)
library(dplyr)
library(ggplot2)
library(tidyr)
library(readxl)
library(DT)
library(patchwork)
library(microbiome)
library(viridis)
library(ggpubr)
library(knitr)

# Source custom functions
source("../R/preprocessing_functions.R")
source("../R/differential_abundance.r")
source("../R/visualization_functions.r")

# Set data paths
processed_data_dir <- "../data/processed_to_ANCOM/"
results_dir <- "../results/original_susceptibility/"

# Create results directory if it doesn't exist
if(!dir.exists(results_dir)) {
  dir.create(results_dir, recursive = TRUE)
}
```

## 2. Load Preprocessed Data

```{r load-data}
# Load the preprocessed phyloseq object
ps <- readRDS(file.path(processed_data_dir, "preprocessed_to_ANCOM_phyloseq.rds"))

# Check that our carriage classifications are present
print("Carriage group distribution:")
table(sample_data(ps)$carriage_group)

# Import demographic data for additional covariates
demographic_data <- read_excel("../data/raw/demographic data _Jan2022_final.YM.20241230.xlsx")

# Clean and prepare demographic data
demographic_data <- demographic_data %>%
  mutate(
    pid = as.character(pid),  # Ensure pid is character for joining
    boardingschool = factor(boardingschool),
    selfsmoking = factor(selfsmoking),
    secondsmoker = factor(secondsmoker),
    AB_month = factor(AB_month),  # Antibiotic use in previous month
    AB_year = factor(AB_year)     # Antibiotic use in previous year
  )

# Merge relevant demographic variables with sample data
# First, get the current sample data
sample_data_df <- data.frame(sample_data(ps))

# Ensure 'pid' is preserved as the identifier
sample_data_with_demo <- sample_data_df %>%
  left_join(demographic_data %>% 
              select(pid, boardingschool, selfsmoking, secondsmoker, 
                     AB_month, AB_year, yearofbirth, family_members), 
            by = "pid")

# Rebuild the sample_data ensuring original sample names are preserved
rownames(sample_data_with_demo) <- sample_data_df$SampleID

# Update the phyloseq object with new sample data
sample_data(ps) <- sample_data(sample_data_with_demo)

# Verify the update worked
print("Updated sample data columns:")
names(sample_data(ps))
```

## 3. Analysis Design and Data Subset Selection
For this susceptibility analysis, we will focus on baseline samples (time point 0) from individuals classified as "Acquisition_carrier" or "Non_carrier". This will allow us to investigate initial microbiome differences that might predispose individuals to acquiring NM.


```{r prepare-ps-list}
# 0. Define your carrier‐group comparisons
comparisons <- list(
  persistent_vs_non       = c("Persistent_carrier",  "Non_carrier"),
  non_vs_acquisition      = c("Non_carrier",         "Acquisition_carrier"),
  persistent_vs_clearance = c("Persistent_carrier",  "Clearance_carrier")
)

# 1. Initialize list to hold prepared phyloseq objects
ps_list <- list()

# 2. Loop over each comparison
for (cmp in names(comparisons)) {
  message("=== Preparing PS for comparison: ", cmp, " ===")
  
  # 2a. Subset & re‐level using our helper
  ps_cmp <- prepare_phyloseq(
    ps_object    = ps,
    group_levels = comparisons[[cmp]],
    group_var    = "carriage_group",
    time_var     = "time",
    time_value   = "0",
    batch_var    = "batch",
    drop_batch   = "4"
  )
  
  # 2b. Sample‐size diagnostics
  if (nsamples(ps_cmp) > 0) {
    # Carriage × batch table
    tbl_cb <- table(
      sample_data(ps_cmp)$carriage_group,
      sample_data(ps_cmp)$batch,
      dnn = c("Carriage Group", "Batch")
    )
    print(tbl_cb)
    message("Total samples: ", nsamples(ps_cmp))
    
    # Overall group size warning
    cg_counts <- table(sample_data(ps_cmp)$carriage_group)
    if (min(cg_counts) < 10) {
      warning("One carriage group has <10 samples; comparisons may be underpowered.")
    } else {
      message("Both carriage groups have ≥10 samples.")
    }
    
    # Within‐batch sample warning
    if (any(tbl_cb > 0 & tbl_cb < 3)) {
      warning("Some carriage×batch cells have <3 samples; faceted analyses may be unstable.")
    }
  } else {
    warning("Comparison '", cmp, "' yielded zero samples after filtering.")
    # Skip alpha‐diversity for empty sets
    ps_list[[cmp]] <- ps_cmp
    next
  }
  
  # 2c. Alpha‐diversity calculation
  if (!is.null(otu_table(ps_cmp, errorIfNULL = FALSE)) && ntaxa(ps_cmp) > 0) {
    alpha_metrics <- c("Shannon", "Simpson", "Observed")
    message("Calculating alpha diversity metrics: ", paste(alpha_metrics, collapse = ", "))
    alpha_df <- estimate_richness(ps_cmp, measures = alpha_metrics)
    
    if (nrow(alpha_df) == nsamples(ps_cmp)) {
      for (m in colnames(alpha_df)) {
        sample_data(ps_cmp)[[m]] <- alpha_df[[m]]
      }
      message("Alpha metrics added to sample_data for ", cmp)
    } else {
      warning(
        "Alpha richness returned ", nrow(alpha_df),
        " rows but expected ", nsamples(ps_cmp), "."
      )
    }
  } else {
    message("Skipping alpha diversity for ", cmp, " (no OTU table or zero taxa).")
  }
  
  # 2d. Store the prepared phyloseq object
  ps_list[[cmp]] <- ps_cmp
}

# ps_list now contains one phyloseq object per comparison:
# names(ps_list) == c("persistent_vs_non","non_vs_acquisition","persistent_vs_clearance")
```

## 4. Exploratory Analysis of Baseline Susceptibility Groups (ps_baseline)
In this section, we explore the microbiome characteristics of the ps_baseline samples (Time 0, Acquisition vs. Non-carriers, Batch 4 excluded). All analyses will be faceted by or account for the remaining batches.

## 4.1 Alpha Diversity
We examine alpha diversity at baseline between Acquisition carriers and Non-carriers, faceted by batch.

```{r 4.1-alpha-div-all}
# Must have run prepare-ps-list chunk already
if (!exists("ps_list") || !exists("comparisons")) {
  stop("ps_list or comparisons not found. Run the prepare-ps-list chunk first.")
}

# Metrics to plot
alpha_metrics_to_plot <- c("Shannon", "Simpson", "Observed")

# Storage
alpha_plots_list    <- list()
alpha_console_stats <- list()

for (cmp in names(ps_list)) {
  message("=== Alpha diversity for comparison: ", cmp, " ===")
  ps_cmp    <- ps_list[[cmp]]
  group_lvls<- comparisons[[cmp]]
  
  if (nsamples(ps_cmp) == 0) {
    warning("ps_list[['", cmp, "']] is empty; skipping.")
    next
  }
  
  # Cleanly extract sample_data as a data.frame
  samp_df <- as.data.frame(
    phyloseq::sample_data(ps_cmp),
    stringsAsFactors = FALSE
  )
  
  # Loop through each metric
  for (metric in alpha_metrics_to_plot) {
    if (!metric %in% colnames(samp_df)) {
      message("Metric '", metric, "' missing for '", cmp, "'; skipping.")
      next
    }
    
    # Prepare data for plotting
    plot_df <- samp_df
    plot_df$carriage_group <- factor(plot_df$carriage_group, levels = group_lvls)
    plot_df$batch           <- factor(plot_df$batch)
    
    cat("\n--- Plotting metric:", metric, "for", cmp, "---\n")
    
    # 1) Boxplot faceted by batch
    p <- ggpubr::ggboxplot(
      plot_df,
      x        = "carriage_group",
      y        = metric,
      color    = "carriage_group",
      palette  = "jco",
      add      = "jitter",
      facet.by = "batch",
      short.panel.labs = FALSE
    ) +
      labs(
        title = sprintf("Baseline %s Diversity (%s vs %s) by Batch", 
                        metric, group_lvls[1], group_lvls[2]),
        x     = "Carriage Group",
        y     = paste(metric, "Index")
      ) +
      theme_minimal(base_size = 10) +
      theme(
        axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "top",
        strip.text     = element_text(size = 10)
      )
    
    # 2) Manual Wilcoxon for Batch "1"
    df_b1 <- plot_df[plot_df$batch == "1", , drop = FALSE]
    if (nrow(df_b1) > 0 &&
        length(unique(df_b1$carriage_group)) == 2 &&
        all(table(df_b1$carriage_group) >= 3) &&
        !all(is.na(df_b1[[metric]]))) {
      
      wt     <- stats::wilcox.test(df_b1[[metric]] ~ df_b1$carriage_group, exact = FALSE)
      p_val  <- wt$p.value
      sig_lbl<- if (p_val < 0.001) "***" else if (p_val < 0.01) "**" else if (p_val < 0.05) "*" else "ns"
      
      stat_df <- data.frame(
        group1     = group_lvls[1],
        group2     = group_lvls[2],
        p          = p_val,
        p.signif   = sig_lbl,
        y.position = max(plot_df[[metric]], na.rm = TRUE) * 1.05,
        batch      = "1",
        stringsAsFactors = FALSE
      )
      
      p <- p + ggpubr::stat_pvalue_manual(
        stat_df,
        label      = "p.signif",
        hide.ns    = TRUE,
        tip.length = 0.01
      )
      
      alpha_console_stats[[cmp]][[metric]] <- wt
    } else {
      message("Skipping Wilcoxon for ", metric, " in batch 1 (insufficient data).")
      print(table(df_b1$carriage_group))
    }
    
    # 3) Store & print
    alpha_plots_list[[cmp]][[metric]] <- p
    print(p)
  }
}

# Now:
# alpha_plots_list[[cmp]][[metric]]  ⇒ your ggboxplot + p‐value annotations
# alpha_console_stats[[cmp]][[metric]] ⇒ the raw wilcox.test() results

```

### 4.2 Beta Diversity

We will now explore community-level differences (beta diversity) between "Acquisition_carrier" and "Non_carrier" groups at baseline, using Bray-Curtis dissimilarity and Principal Coordinate Analysis (PCoA). Plots will be faceted by batch, and PERMANOVA will be used to assess statistical significance while accounting for batch and cohort effects.

```{r 4.2-beta-div-all}
# Ensure ps_list and comparisons are defined
if (!exists("ps_list") || !exists("comparisons")) {
  stop("ps_list or comparisons not found. Run the prepare-ps-list chunk first.")
}

# Loop over each comparison
for (cmp in names(ps_list)) {
  message("=== Beta diversity for comparison: ", cmp, " ===")
  ps_cmp     <- ps_list[[cmp]]
  group_lvls <- comparisons[[cmp]]
  
  # Skip if too few samples
  if (nsamples(ps_cmp) < 3) {
    message("ps_list[['", cmp, "']] has fewer than 3 samples. Skipping beta diversity analysis.")
    next
  }
  
  # --- 1. Calculate Bray-Curtis dissimilarity ---
  message("Calculating Bray-Curtis dissimilarity for ", cmp, "...")
  dist_bray_cmp <- phyloseq::distance(ps_cmp, method = "bray")
  
  # --- 2. Perform PCoA ---
  message("Performing PCoA for ", cmp, "...")
  ord_pcoa_bray_cmp <- phyloseq::ordinate(ps_cmp, method = "PCoA", distance = dist_bray_cmp)
  
  # --- 3. Plot PCoA, faceted by Batch ---
  if (!is.null(ord_pcoa_bray_cmp$vectors)) {
    sample_df_for_plot <- as.data.frame(
      phyloseq::sample_data(ps_cmp),
      stringsAsFactors = FALSE
    )
    if ("cohort" %in% names(sample_df_for_plot)) {
      sample_df_for_plot$cohort <- factor(sample_df_for_plot$cohort)
    }
    
    # axis labels
    axis_labels <- c("PCo1", "PCo2")
    if (!is.null(ord_pcoa_bray_cmp$values$Relative_eig)) {
      eig <- ord_pcoa_bray_cmp$values$Relative_eig
      axis_labels <- c(
        paste0("PCo1 [", round(eig[1]*100,1), "%]"),
        paste0("PCo2 [", round(eig[2]*100,1), "%]")
      )
    }
    
    beta_plot <- phyloseq::plot_ordination(
      ps_cmp, ord_pcoa_bray_cmp,
      color = "carriage_group",
      shape = if("cohort" %in% names(sample_df_for_plot)) "cohort" else NULL
    ) +
      ggplot2::geom_point(size = 3, alpha = 0.75) +
      ggplot2::stat_ellipse(
        ggplot2::aes(group = carriage_group, fill = carriage_group),
        geom = "polygon", alpha = 0.2, show.legend = FALSE, type = "t"
      ) +
      ggplot2::facet_wrap(~ batch) +
      ggplot2::labs(
        title = sprintf(
          "PCoA (Bray-Curtis) Baseline (%s vs %s) by Batch",
          group_lvls[1], group_lvls[2]
        ),
        x = axis_labels[1], y = axis_labels[2],
        color = "Carriage Group",
        shape = if("cohort" %in% names(sample_df_for_plot)) "Cohort" else NULL
      ) +
      ggplot2::theme_bw(base_size = 10) +
      ggplot2::theme(
        legend.position = "top",
        strip.text      = element_text(size = 10)
      )
    print(beta_plot)
  } else {
    message("PCoA ordination failed for ", cmp, ". Cannot plot beta diversity.")
  }
  
  # --- 4. PERMANOVA Tests using with() so data is evaluated in sample_df_for_plot ---
  sample_df_cmp <- as.data.frame(
    phyloseq::sample_data(ps_cmp),
    stringsAsFactors = FALSE
  )
  
  # Only run if we have at least 3 samples in >1 group
  if (nrow(sample_df_cmp) >= 3 &&
      length(unique(sample_df_cmp$carriage_group)) > 1 &&
      length(unique(sample_df_cmp$batch)) > 0) {
    
    cat("\n--- PERMANOVA (carriage_group + batch) for ", cmp, " ---\n")
    with(sample_df_cmp, {
      perm1 <- vegan::adonis2(
        dist_bray_cmp ~ carriage_group + batch,
        permutations = 999,
        by           = "terms"
      )
      print(perm1)
    })
    
    if ("cohort" %in% colnames(sample_df_cmp) &&
        length(unique(sample_df_cmp$cohort)) > 1) {
      cat("\n--- PERMANOVA (carriage_group + batch + cohort) for ", cmp, " ---\n")
      with(sample_df_cmp, {
        perm2 <- vegan::adonis2(
          dist_bray_cmp ~ carriage_group + batch + cohort,
          permutations = 999,
          by           = "terms"
        )
        print(perm2)
      })
    } else {
      message("Cohort variable not suitable for PERMANOVA in ", cmp, ". Skipping cohort term.")
    }
    
  } else {
    message("Skipping PERMANOVA for ", cmp, " due to insufficient samples or groups.")
  }
}

# Optional: Display relevant beta diversity plots from preprocessing for context
# These might show all time points or different subsets.
preprocessing_plot_path_beta_longitudinal <- "../results/preprocessing_plots/longitudinal_pcoa_faceted_susc_analysis.png" 
if (file.exists(preprocessing_plot_path_beta_longitudinal)) {
  # print("Displaying pre-generated longitudinal PCoA plot from preprocessing (shows all time points for Acq vs Non):")
  # knitr::include_graphics(preprocessing_plot_path_beta_longitudinal) 
  # cat("Note: Baseline samples from 'Acquisition_carrier' and 'Non_carrier' groups are the starting points of trajectories in the plot above.\n")
}

```

### 4.3 Taxonomic Composition

We will visualize the relative abundance of major genera at baseline to compare "Acquisition_carrier" and "Non_carrier" groups, faceted by batch.

```{r 4.3-taxonomic-composition-all}
# Ensure ps_list and comparisons are defined
if (!exists("ps_list") || !exists("comparisons")) {
  stop("ps_list or comparisons not found. Run the prepare-ps-list chunk first.")
}

# Prepare storage for plots
taxa_comp_plots <- list()

# Loop over each comparison
for (cmp in names(ps_list)) {
  message("=== Taxonomic composition for comparison: ", cmp, " ===")
  ps_cmp    <- ps_list[[cmp]]
  group_lvls<- comparisons[[cmp]]
  
  # 0. Skip if empty
  if (nsamples(ps_cmp) == 0) {
    warning("ps_list[['", cmp, "']] has zero samples. Skipping taxonomic composition.")
    next
  }
  
  # --- 1. Aggregate to Genus Level ---
  ps_baseline_genus <- tax_glom(ps_cmp, taxrank = "Genus", NArm = FALSE)
  
  # --- 2. Transform to Relative Abundance ---
  ps_baseline_genus_rel <- transform_sample_counts(
    ps_baseline_genus,
    function(x) x / sum(x)
  )
  
  # --- 3. Identify Top N Genera ---
  mean_abund       <- taxa_sums(ps_baseline_genus_rel) / nsamples(ps_baseline_genus_rel)
  topN_genera      <- 15
  num_taxa_to_plot <- min(topN_genera, ntaxa(ps_baseline_genus_rel))
  
  if (num_taxa_to_plot > 0) {
    top_genera_names <- names(sort(mean_abund, decreasing = TRUE))[1:num_taxa_to_plot]
    
    ps_plot_data_taxa_topN <- prune_taxa(
      top_genera_names,
      ps_baseline_genus_rel
    )
    
    # Ensure unique x-axis IDs
    sample_data(ps_plot_data_taxa_topN)$plot_sample_id <-
      make.names(sample_names(ps_plot_data_taxa_topN), unique = TRUE)
    
    # --- 4. Create Stacked Bar Plot ---
    p <- plot_bar(
      ps_plot_data_taxa_topN,
      x    = "plot_sample_id",
      fill = "Genus"
    ) +
      geom_bar(stat = "identity", position = "stack") +
      facet_grid(batch ~ carriage_group, scales = "free_x", space = "free_x") +
      labs(
        title = sprintf(
          "Baseline Top %d Genera (%s vs %s) by Batch & Group",
          num_taxa_to_plot, group_lvls[1], group_lvls[2]
        ),
        x = "Sample",
        y = "Relative Abundance"
      ) +
      theme_minimal(base_size = 9) +
      theme(
        axis.text.x    = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 5),
        legend.position= "bottom",
        legend.title   = element_text(size = 8),
        legend.text    = element_text(size = 7),
        strip.text     = element_text(size = 8)
      ) +
      guides(fill = guide_legend(nrow = 3, title.position = "top"))
    
    print(p)
    taxa_comp_plots[[cmp]] <- p
    
  } else {
    message("No taxa to plot for '", cmp, "': zero genera after filtering.")
  }
}

# taxa_comp_plots[[cmp]] contains the genus‐composition barplot for each comparison


```

## 5. Differential Abundance Analysis with ANCOM-BC2 (Baseline)

We will now use ANCOM-BC2 to identify differentially abundant genera at baseline between "Acquisition_carrier" and "Non_carrier" groups, while controlling for batch and other relevant covariates.

```{r load-ancombc2-all-models, include=FALSE}
# Path to the combined ANCOM-BC2 results for all comparisons
all_ancom_rds_file <- file.path(results_dir, "susceptibility_all_comparisons_ancombc2_models.rds")

# Initialize storage
all_ancom_results <- list()

if (file.exists(all_ancom_rds_file)) {
  message("Loading ANCOM-BC2 results for all comparisons from: ", all_ancom_rds_file)
  all_ancom_results <- readRDS(all_ancom_rds_file)
  
  # Quick check of what’s loaded
  cat("Loaded comparisons:\n")
  print(names(all_ancom_results))
  
  # Optionally flag that models are loaded
  models_loaded_successfully <- TRUE
} else {
  message("ANCOM-BC2 results file not found at: ", all_ancom_rds_file,
          "\nRun the `run-ancombc2-all-models` chunk to generate and save them.")
  models_loaded_successfully <- FALSE
}

```

Here is the actual training of the models. No need to run - the upper block already loads a pretrained rds file with the models.
nik change - 

**What changed compared to original chunk:**

- **Looped over every comparison** in `ps_list` rather than using a single `ps_baseline`.
- **Replaced** the four separate `tryCatch` calls with a single call to our **`run_ancombc2_models()`** wrapper, passing the named `formulas` list.
- **Checked** for required covariates and enforced them as factors **for each** `ps_cmp` in the loop.
- **Saved** all results into a single nested list (`all_ancom_results`) keyed by comparison name, and wrote them to an RDS file.
- **Printed** a concise summary of significant taxa counts for each model and comparison.

This preserves all your original covariate checks, model parameters, and downstream summaries, but applies them automatically across all carrier‐group comparisons.


```{r run-ancombc2-all-models-fixed}
# Ensure ps_list and comparisons are defined
if (!exists("ps_list") || !exists("comparisons")) {
  stop("ps_list or comparisons not found. Run the prepare-ps-list chunk first.")
}

# Initialize storage
all_ancom_results <- list()

for (cmp in names(ps_list)) {
  message("=== Running ANCOM-BC2 for comparison: ", cmp, " ===")
  ps_cmp <- ps_list[[cmp]]
  
  if (nsamples(ps_cmp) == 0) {
    warning("No samples for ", cmp, "; skipping.")
    next
  }
  
  # 1. Choose formulas explicitly per comparison
  if (cmp == "persistent_vs_clearance") {
    # Omit cohort entirely
    formulas <- list(
      m1 = "carriage_group + batch",
      m3 = "carriage_group + batch + selfsmoking + boardingschool",
      m4 = "carriage_group + batch + selfsmoking + boardingschool + AB_month"
    )
  } else {
    # Keep cohort for the other comparisons
    formulas <- list(
      m1 = "carriage_group + batch",
      m2 = "carriage_group + batch + cohort",
      m3 = "carriage_group + batch + selfsmoking + boardingschool",
      m4 = "carriage_group + batch + cohort + selfsmoking + boardingschool + AB_month"
    )
  }
  
  # 2. Run all four models using our helper
  res <- run_ancombc2_models(
    ps_object = ps_cmp,
    formulas  = formulas,
    group_var = "carriage_group",
    tax_level = "Genus",
    prv_cut   = 0.10,
    seed      = 123
  )
  all_ancom_results[[cmp]] <- res
}

# 3. Save the updated results
saveRDS(
  all_ancom_results,
  file.path(results_dir, "susceptibility_all_comparisons_ancombc2_models.rds")
)
message("Saved fixed ANCOM-BC2 results with cohort removed for persistent_vs_clearance.")


# Optional summary printout
for(cmp in names(all_ancom_results)) {
  cat("\n---", cmp, "---\n")
  models <- all_ancom_results[[cmp]]
  for(mn in names(models)) {
    mod <- models[[mn]]
    if (!is.null(mod$error)) {
      cat(mn, "failed:", mod$error, "\n")
    } else {
      # count significant taxa for carriage_group
      diff_cols <- grep("^diff_carriage_group", colnames(mod$res), value=TRUE)
      if (length(diff_cols)==1) {
        sigs <- sum(mod$res[[diff_cols]], na.rm=TRUE)
        cat(mn, ":", sigs, "significant taxa\n")
      } else {
        cat(mn, ": could not identify diff column\n")
      }
    }
  }
}

```

##6. vis check for chunk 5 models:

```{r summarize-carriage-group-ancom-results, echo=FALSE}
# Ensure the combined ANCOM-BC2 results are loaded
if (!exists("all_ancom_results")) {
  stop("all_ancom_results not found. Run the load-ancombc2-all-models chunk first.")
}

# Loop over each comparison and each model within it
for (cmp in names(all_ancom_results)) {
  message("=== Processing results for comparison: ", cmp, " ===")
  models_list <- all_ancom_results[[cmp]]
  
  for (model_name in names(models_list)) {
    ancom_model_result <- models_list[[model_name]] # This is the full output from ancombc2()
    
    # Skip models that failed to run
    if (!is.null(ancom_model_result$error)) {
      warning("Skipping ", cmp, "/", model_name, " (error: ", ancom_model_result$error, ")")
      next
    }
    
    # Ensure the 'res' data frame exists within the ancom_model_result
    if (is.null(ancom_model_result$res) || !is.data.frame(ancom_model_result$res)) {
      warning("Skipping ", cmp, "/", model_name, " (no 'res' data frame found).")
      next
    }
    
    # Generate plots for ALL terms in this model using your existing function.
    vis_output <- plot_ancom_all_terms(
      ancom_model        = ancom_model_result, 
      top_n              = 20, 
      filter_sensitivity = TRUE, 
      title_prefix       = paste("ANCOM-BC2", cmp, model_name),
      subtitle           = NULL 
    )
    
    # Loop through each contrast for which a plot was potentially generated
    if (length(vis_output$plots) > 0) {
      for (contrast_name_from_plot_func in names(vis_output$plots)) {
        
        # Only proceed if the contrast is related to "carriage_group"
        if (grepl("carriage_group", contrast_name_from_plot_func)) {
          
          # 1. Print the plot for THIS "carriage_group" contrast
          plot_title <- paste(cmp, model_name, "-", contrast_name_from_plot_func)
          if (!is.null(vis_output$plots[[contrast_name_from_plot_func]])) {
            print(
              vis_output$plots[[contrast_name_from_plot_func]] +
                ggplot2::ggtitle(plot_title)
            )
          } else {
            message(paste0("Plot object for contrast `", contrast_name_from_plot_func, "` is NULL."))
          }
          
          # 2. Print the detailed table for THIS "carriage_group" contrast
          res_df_for_table <- ancom_model_result$res 
          
          lfc_col_for_table <- paste0("lfc_", contrast_name_from_plot_func)
          diff_col_for_table <- paste0("diff_", contrast_name_from_plot_func)
          q_col_for_table <- paste0("q_", contrast_name_from_plot_func)
          ss_col_for_table <- paste0("passed_ss_", contrast_name_from_plot_func)
          
          if (!all(c(lfc_col_for_table, diff_col_for_table) %in% colnames(res_df_for_table))) {
            message(paste0("Skipping table for ", cmp, "/", model_name, " - Contrast: `", contrast_name_from_plot_func, 
                           "` (LFC or Diff column missing in ancom_model_result$res)."))
            next 
          }

          significant_taxa_table_data <- res_df_for_table[
            res_df_for_table[[diff_col_for_table]] == TRUE & !is.na(res_df_for_table[[diff_col_for_table]]), 
          ]
          
          if (ss_col_for_table %in% colnames(significant_taxa_table_data)) {
            significant_taxa_table_data <- significant_taxa_table_data[
              significant_taxa_table_data[[ss_col_for_table]] == TRUE & !is.na(significant_taxa_table_data[[ss_col_for_table]]),
            ]
          }
          
          if (nrow(significant_taxa_table_data) > 0) {
            significant_taxa_table_data <- significant_taxa_table_data[
              order(-abs(significant_taxa_table_data[[lfc_col_for_table]])), 
            ]
            
            cols_for_display <- c("taxon", lfc_col_for_table)
            if (q_col_for_table %in% colnames(significant_taxa_table_data)) {
              cols_for_display <- c(cols_for_display, q_col_for_table)
            }
            if (diff_col_for_table %in% colnames(significant_taxa_table_data)) {
              cols_for_display <- c(cols_for_display, diff_col_for_table)
            }
            if (ss_col_for_table %in% colnames(significant_taxa_table_data)) {
              cols_for_display <- c(cols_for_display, ss_col_for_table)
            }
            cols_for_display <- intersect(cols_for_display, colnames(significant_taxa_table_data))
            table_df_to_print <- significant_taxa_table_data[, cols_for_display, drop = FALSE]
            
            # Print table header using cat
            table_header_text <- paste0("Summary Table for: ", cmp, " | Model: ", model_name, " | Contrast: `", contrast_name_from_plot_func, "`")
            cat(paste0("\n\n--- ", table_header_text, " ---\n")) # Using cat for a distinct header
            
            # Print the data frame directly
            print(table_df_to_print, row.names = FALSE)
            cat("\n--- End of Table ---\n\n") # Footer for clarity
          }
        } # End if (grepl("carriage_group", ...))
      } # End loop through contrasts from vis_output$plots
    } else {
      message(paste0("No plots were generated by plot_ancom_all_terms for ", cmp, "/", model_name, "."))
    }
  } # End loop through models_list
} # End loop through all_ancom_results
```

```{r visualize-ancom-results}
# redundant, see chunk above

# # Ensure the combined ANCOM-BC2 results are loaded
# if (!exists("all_ancom_results")) {
#   stop("all_ancom_results not found. Run the load-ancombc2-all-models chunk first.")
# }
# 
# # Loop over each comparison and each model within it
# for (cmp in names(all_ancom_results)) {
#   message("=== Visualizing contrasts for comparison: ", cmp, " ===")
#   models_list <- all_ancom_results[[cmp]]
#   
#   for (model_name in names(models_list)) {
#     ancom_model <- models_list[[model_name]]
#     
#     # Skip models that failed to run
#     if (!is.null(ancom_model$error)) {
#       warning("Skipping visualization for ", cmp, "/", model_name, " (error: ", ancom_model$error, ")")
#       next
#     }
#     
#     # Generate plots for all terms in this model
#     vis <- plot_ancom_all_terms(
#       ancom_model        = ancom_model,
#       top_n              = 20,
#       filter_sensitivity = TRUE,
#       title_prefix       = paste("ANCOM-BC2", cmp, model_name),
#       subtitle           = NULL
#     )
#     
#     # Print each contrast plot with updated title
#     for (contrast in names(vis$plots)) {
#       print(
#         vis$plots[[contrast]] +
#         ggplot2::ggtitle(paste(cmp, model_name, "-", contrast))
#       )
#     }
#   }
# }

```

## 8. Interpretation and Biological Significance

In this section, we'll interpret the biological significance of the differentially abundant taxa identified in our analysis.

```{r biological-interpretation-all-final}
# 0. Preconditions
if (!exists("all_ancom_results") || !exists("ps_list") || !exists("comparisons")) {
  stop("Make sure all_ancom_results, prepare-ps-list, and load-results chunks have run.")
}

# 1. Helper to pull taxonomy for given taxon IDs
get_taxa_table <- function(ps_obj, taxa_ids) {
  if (length(taxa_ids) == 0) return(NULL)
  tt <- as.data.frame(phyloseq::tax_table(ps_obj), stringsAsFactors = FALSE)
  sig <- tt[rownames(tt) %in% taxa_ids, , drop = FALSE]
  sig$taxon_id <- rownames(sig)
  return(sig)
}

# 2. Extract significant taxa using the 'taxon' column
sig_taxa_by_cmp <- list()
for (cmp in names(all_ancom_results)) {
  sig_taxa_by_cmp[[cmp]] <- list()
  for (model_name in names(all_ancom_results[[cmp]])) {
    mod <- all_ancom_results[[cmp]][[model_name]]
    if (!is.null(mod$error)) next
    
    res_df    <- mod$res
    # Use the taxon column
    taxa_all  <- res_df$taxon
    diff_cols <- grep("^diff_carriage_group", names(res_df), value = TRUE)
    ss_cols   <- grep("^passed_ss_carriage_group", names(res_df), value = TRUE)
    
    if (length(diff_cols) == 1 && length(ss_cols) == 1) {
      mask     <- res_df[[diff_cols]] == 1 & res_df[[ss_cols]] == TRUE
      taxa_ids <- taxa_all[mask]
    } else if (length(diff_cols) == 1) {
      mask     <- res_df[[diff_cols]] == 1
      taxa_ids <- taxa_all[mask]
    } else {
      taxa_ids <- character(0)
    }
    
    sig_taxa_by_cmp[[cmp]][[model_name]] <- taxa_ids
  }
}

# 3. Print taxonomy for each model
for (cmp in names(sig_taxa_by_cmp)) {
  ps_cmp <- ps_list[[cmp]]
  for (model_name in names(sig_taxa_by_cmp[[cmp]])) {
    taxa_ids <- sig_taxa_by_cmp[[cmp]][[model_name]]
    cat("\n=== Taxonomy for", cmp, "/", model_name, "===\n")
    if (length(taxa_ids)) {
      tt <- get_taxa_table(ps_cmp, taxa_ids)
      print(tt)
    } else {
      cat("No significant taxa passing sensitivity filter.\n")
    }
  }
}

# 4. Summarize all unique taxa
all_taxa <- unique(unlist(sig_taxa_by_cmp))
cat("\n=== Summary of all unique significant taxa ===\n")
cat("Total unique taxa:", length(all_taxa), "\n")

if (length(all_taxa)) {
  tt_all <- get_taxa_table(ps_list[[1]], all_taxa)
  
  phylum_summary <- tt_all %>%
    dplyr::group_by(Phylum) %>%
    dplyr::summarise(count = n()) %>%
    dplyr::arrange(dplyr::desc(count))
  cat("\nPhylum distribution:\n"); print(phylum_summary)
  
  family_summary <- tt_all %>%
    dplyr::group_by(Family) %>%
    dplyr::summarise(count = n()) %>%
    dplyr::arrange(dplyr::desc(count))
  cat("\nTop 10 Families:\n"); print(head(family_summary, 10))
} else {
  cat("No taxa to summarize.\n")
}


```



## 9. Export Results and Visualizations

```{r export-results}
# Save the full ANCOM-BC2 results object
saveRDS(ancombc2_result, file = file.path(results_dir, "original_susceptibility_ancombc2_results.rds"))

# Save the visualization results
saveRDS(ancombc2_vis, file = file.path(results_dir, "original_susceptibility_visualization_results.rds"))

# Create a summary of significant findings
susceptibility_summary <- list(
  analysis_info = list(
    date = Sys.Date(),
    samples_analyzed = nrow(sample_data(ps_suscept_original)),
    group_sizes = table(sample_data(ps_suscept_original)$carriage_group),
    covariates = c("selfsmoking", "boardingschool", "AB_month")
  ),
  significance_summary = list(
    total_taxa_analyzed = nrow(res_primary),
    significant_taxa = lapply(diff_cols, function(col) sum(res_primary[[col]] == 1)),
    significant_taxa_passing_ss = lapply(diff_cols, function(col) {
      ss_col <- gsub("diff_", "passed_ss_", col)
      if(ss_col %in% colnames(res_primary)) {
        sum(res_primary[[col]] == 1 & res_primary[[ss_col]] == TRUE)
      } else {
        sum(res_primary[[col]] == 1)
      }
    })
  ),
  differentially_abundant_taxa = sig_taxa_passing_ss
)

# Save the summary
saveRDS(susceptibility_summary, 
       file = file.path(results_dir, "original_susceptibility_analysis_summary.rds"))

# Save a text summary of results
sink(file = file.path(results_dir, "original_susceptibility_results_summary.txt"))
cat("=== NM ORIGINAL SUSCEPTIBILITY ANALYSIS RESULTS ===\n\n")
cat("Analysis Date:", as.character(Sys.Date()), "\n")
cat("Samples Analyzed:", nrow(sample_data(ps_suscept_original)), "\n")
cat("Group Sizes:\n")
print(table(sample_data(ps_suscept_original)$carriage_group))
cat("\n")

cat("=== SIGNIFICANT TAXA ===\n\n")
display_results(ancombc2_vis, "SIGNIFICANT TAXA FOR ORIGINAL SUSCEPTIBILITY ANALYSIS")
cat("\n")

cat("=== PERMANOVA RESULTS ===\n\n")
print(permanova_result)
cat("\n")

sink()
```

## 10. Session Info

```{r session-info}
sessionInfo()
```